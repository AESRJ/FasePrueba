name: Deploy to GitHub Pages

on:
  push:
    branches: [ master ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Pygbag
        run: |
          pip install pygbag

      - name: Build Game
        run: |
          cd $GITHUB_WORKSPACE
          pygbag --build main.py
          mv build/web/main.html build/web/index.html || true

          # --- VITAL: CREAR CARPETA ASSETS Y COPIAR VIDEO ---
          mkdir -p build/web/assets
          cp assets/intro.mp4 build/web/assets/intro.mp4

      # --- DISEÑO ULTRA CYBERPUNK ---
      - name: Inject Video and Deluxe Design
        run: |
          import os
          
          html_path = 'build/web/index.html'
          
          # 1. CSS DELUXE: ANIMACIONES, CRT Y NEON
          custom_css = """
          <style>
              @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&display=swap');

              body {
                  background-color: #050510 !important;
                  margin: 0; overflow: hidden; height: 100vh;
                  display: flex; justify-content: center; align-items: center;
                  font-family: 'Orbitron', sans-serif;
              }

              /* FONDO ANIMADO */
              .cyber-grid {
                  position: absolute; top: 0; left: 0; width: 200vw; height: 200vh;
                  background-image: 
                      linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
                  background-size: 50px 50px;
                  transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
                  animation: grid-move 20s linear infinite;
                  z-index: -1;
              }
              @keyframes grid-move { 0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); } 100% { transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px); } }

              /* MARCO DEL JUEGO */
              canvas {
                  box-shadow: 0 0 80px rgba(0, 255, 255, 0.2);
                  border: 1px solid rgba(0, 255, 255, 0.5);
                  border-radius: 4px;
                  z-index: 10;
              }

              /* PANTALLA DE INTRODUCCION */
              #intro-overlay {
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background-color: #000; z-index: 999999 !important;
                  display: flex; flex-direction: column; justify-content: center; align-items: center;
              }
              
              /* VIDEO */
              video { 
                  width: 100%; max-width: 1280px; height: auto; 
                  box-shadow: 0 0 50px rgba(0,0,0,0.8);
              }

              /* BOTÓN DE INICIO ESTILO NEON */
              #start-btn {
                  margin-top: 30px; padding: 20px 60px;
                  font-family: 'Orbitron', sans-serif; font-size: 20px; letter-spacing: 2px;
                  color: #0ff; background: rgba(0, 20, 20, 0.9);
                  border: 2px solid #0ff; border-radius: 5px;
                  cursor: pointer; text-transform: uppercase;
                  box-shadow: 0 0 15px #0ff, inset 0 0 15px #0ff;
                  text-shadow: 0 0 10px #0ff;
                  transition: all 0.2s;
                  animation: pulse 2s infinite;
                  position: absolute; bottom: 15%;
                  z-index: 1000000;
              }
              #start-btn:hover { background: #0ff; color: #000; box-shadow: 0 0 30px #0ff, inset 0 0 30px #0ff; }
              @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 20px #0ff; } 100% { opacity: 0.8; } }

              /* EFECTO SCANLINES (CRT) */
              .scanlines {
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
                  background-size: 100% 4px;
                  pointer-events: none; z-index: 9999999;
                  opacity: 0.6;
              }

              .hidden { opacity: 0; pointer-events: none; transition: opacity 1.5s ease-out; }
          </style>
          """

          # 2. HTML: Agregamos el div de fondo y scanlines
          video_html = """
          <div class="cyber-grid"></div>
          <div class="scanlines"></div>
          
          <div id="intro-overlay">
              <video id="myVideo" playsinline>
                  <source src="assets/intro.mp4" type="video/mp4">
              </video>
              <button id="start-btn">INITIALIZE SYSTEM</button>
          </div>
          """

          # 3. JS: Lógica
          video_js = """
          <script>
              window.addEventListener('load', function() {
                  var overlay = document.getElementById('intro-overlay');
                  var vid = document.getElementById('myVideo');
                  var btn = document.getElementById('start-btn');
                  var canvas = document.getElementById('canvas');
                  
                  if(btn && vid) {
                      btn.onclick = function() {
                          btn.innerText = "LOADING...";
                          btn.style.opacity = "0.5";
                          vid.play().then(() => {
                              btn.style.display = 'none';
                          }).catch(e => { 
                              console.log("Auto-play blocked or error", e);
                              overlay.classList.add('hidden'); 
                          });
                      };
                      
                      vid.onended = function() {
                          overlay.classList.add('hidden');
                          setTimeout(() => { overlay.style.display = 'none'; }, 1500);
                          if(canvas) canvas.focus();
                      };
                  }
              });
          </script>
          """
          
          # INYECCIÓN
          with open(html_path, 'r', encoding='utf-8') as f:
              content = f.read()
          
          if '</head>' in content:
              content = content.replace('</head>', custom_css + '</head>')
          else:
              content = custom_css + content
          
          if '</body>' in content:
              content = content.replace('</body>', video_html + video_js + '</body>')
          else:
              content = content + video_html + video_js
          
          with open(html_path, 'w', encoding='utf-8') as f:
              f.write(content)
        shell: python

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build/web