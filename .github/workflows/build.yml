name: Deploy to GitHub Pages

on:
  push:
    branches: [ master ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Pygbag
        run: |
          pip install pygbag

      - name: Build Game
        run: |
          cd $GITHUB_WORKSPACE
          # Construimos el juego
          pygbag --build main.py
          
          # Renombramos main.html a index.html
          mv build/web/main.html build/web/index.html || true

          # --- VITAL: CREAR CARPETA ASSETS Y COPIAR VIDEO ---
          mkdir -p build/web/assets
          cp assets/intro.mp4 build/web/assets/intro.mp4

      # --- PASO DE DISEÑO E INTRODUCCIÓN ---
      - name: Inject Video and Design
        run: |
          import os
          
          html_path = 'build/web/index.html'
          
          # 1. EL CSS (ESTILO CYBERPUNK)
          custom_css = """
          <style>
              body {
                  background-color: #050510 !important;
                  background-image: 
                      linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px) !important;
                  background-size: 40px 40px;
              }
              canvas {
                  box-shadow: 0 0 50px rgba(0, 255, 255, 0.4);
                  border: 2px solid #00ffff;
                  border-radius: 8px;
              }
              #intro-overlay {
                  position: fixed;
                  top: 0; left: 0; width: 100%; height: 100%;
                  background-color: #000000 !important;
                  z-index: 999999 !important;
                  display: flex;
                  flex-direction: column;
                  justify-content: center;
                  align-items: center;
              }
              video { width: 100%; max-width: 1280px; height: auto; }
              #start-btn {
                  margin-top: 20px; padding: 15px 40px;
                  font-family: monospace; font-size: 24px; font-weight: bold;
                  color: #00ffff; background: transparent; border: 2px solid #00ffff;
                  cursor: pointer; box-shadow: 0 0 15px #00ffff; z-index: 1000000;
              }
              #start-btn:hover { background: #00ffff; color: #000; }
              .hidden { opacity: 0; pointer-events: none; transition: opacity 1s; }
          </style>
          """

          # 2. EL HTML (VIDEO)
          video_html = """
          <div id="intro-overlay">
              <video id="myVideo" playsinline>
                  <source src="assets/intro.mp4" type="video/mp4">
              </video>
              <button id="start-btn">INICIAR SISTEMA</button>
          </div>
          """

          # 3. EL JS (LOGICA)
          video_js = """
          <script>
              window.addEventListener('load', function() {
                  var overlay = document.getElementById('intro-overlay');
                  var vid = document.getElementById('myVideo');
                  var btn = document.getElementById('start-btn');
                  var canvas = document.getElementById('canvas');
                  
                  if(btn && vid) {
                      btn.onclick = function() {
                          btn.style.display = 'none';
                          vid.play().catch(e => { overlay.classList.add('hidden'); });
                      };
                      vid.onended = function() {
                          overlay.classList.add('hidden');
                          setTimeout(() => { overlay.style.display = 'none'; }, 1000);
                          if(canvas) canvas.focus();
                      };
                  }
              });
          </script>
          """
          
          # LEER Y MODIFICAR
          with open(html_path, 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Inyectar CSS en el Head
          if '</head>' in content:
              content = content.replace('</head>', custom_css + '</head>')
          else:
              content = custom_css + content
          
          # Inyectar Video y JS en el Body (O AL FINAL SI FALLA)
          if '</body>' in content:
              content = content.replace('</body>', video_html + video_js + '</body>')
          else:
              # Si no encuentra el body, lo pegamos al final del todo
              content = content + video_html + video_js
          
          with open(html_path, 'w', encoding='utf-8') as f:
              f.write(content)
        shell: python

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build/web